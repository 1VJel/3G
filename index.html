<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dom치c칤 칔koly a Testy</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  body {
    margin: 0;
    font-family: 'Segoe UI', sans-serif;
    background-color: #121212;
    color: #fff;
  }
  .container {
    display: flex;
    gap: 20px;
    padding: 20px;
  }
  .column {
    flex: 1;
    background-color: #1e1e1e;
    padding: 15px;
    border-radius: 10px;
    max-height: 90vh;
    overflow-y: auto;
  }
  h2 {
    margin-top: 0;
    border-bottom: 1px solid #444;
    padding-bottom: 5px;
  }
  ul {
    list-style: none;
    padding: 0;
    margin: 10px 0;
  }
  li {
    background-color: #2a2a2a;
    margin-bottom: 8px;
    padding: 10px;
    border-radius: 8px;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  li .votes {
    display: flex;
    gap: 5px;
  }
  .vote-btn {
    width: 28px;
    height: 28px;
    display: flex;
    justify-content: center;
    align-items: center;
    border-radius: 50%;
    opacity: 0.7;
    cursor: pointer;
    user-select: none;
  }
  .vote-btn:hover { opacity: 1; }
  .like { background-color: #4CAF50; }
  .dislike { background-color: #F44336; }
  input, select, button {
    margin: 5px 0;
    padding: 8px 10px;
    border-radius: 12px;
    border: none;
    outline: none;
  }
  input, select { width: 100%; box-sizing: border-box; }
  button {
    cursor: pointer;
    background-color: #6200EE;
    color: white;
    font-weight: bold;
    width: 100%;
    border-radius: 20px;
    padding: 10px;
  }
  button:hover { background-color: #7B1FA2; }
</style>
</head>
<body>

<div class="container">
  <!-- DOM츼C칈 칔KOLY -->
  <div class="column" id="tasks-column">
    <h2>Dom치c칤 칔koly</h2>
    <ul id="tasks-list"></ul>

    <h3>P콏idat 칰kol</h3>
    <input id="task-subject" placeholder="P콏edm캩t (1-2 p칤smena)">
    <input id="task-desc" placeholder="Popis 칰kolu">
    <input id="task-date" type="date">
    <button onclick="addPendingTask()">Odeslat</button>

    <h3>N치vrhy 칰kol콢</h3>
    <ul id="tasks-pending-list"></ul>
  </div>

  <!-- TESTY -->
  <div class="column" id="tests-column">
    <h2>Testy</h2>
    <ul id="tests-list"></ul>

    <h3>P콏idat test</h3>
    <input id="test-subject" placeholder="P콏edm캩t (1-2 p칤smena)">
    <input id="test-desc" placeholder="Popis testu">
    <input id="test-date" type="date">
    <button onclick="addPendingTest()">Odeslat</button>

    <h3>N치vrhy test콢</h3>
    <ul id="tests-pending-list"></ul>
  </div>
</div>

<script>
  // Inicializace Supabase
  const supabaseUrl = 'YOUR_SUPABASE_URL';
  const supabaseKey = 'YOUR_SUPABASE_ANON_KEY';
  const supabase = supabase.createClient(supabaseUrl, supabaseKey);

  const ip = () => fetch('https://api.ipify.org?format=json').then(r => r.json()).then(d => d.ip);

  // Na캜ten칤 dat
  async function loadData() {
    const { data: tasks } = await supabase.from('task').select('*').order('date');
    const { data: tests } = await supabase.from('tests').select('*').order('date');
    const { data: tasks_pending } = await supabase.from('tasks_pending').select('*');
    const { data: tests_pending } = await supabase.from('tests_pending').select('*');

    renderList('tasks-list', tasks);
    renderPending('tasks-pending-list', tasks_pending, 'tasks_pending');
    renderList('tests-list', tests);
    renderPending('tests-pending-list', tests_pending, 'tests_pending');
  }

  function renderList(elementId, items) {
    const ul = document.getElementById(elementId);
    ul.innerHTML = '';
    items.forEach(item => {
      const li = document.createElement('li');
      li.textContent = `${item.subject} - ${item.desc} (${item.date})`;
      ul.appendChild(li);
    });
  }

  function renderPending(elementId, items, table) {
    const ul = document.getElementById(elementId);
    ul.innerHTML = '';
    items.forEach(item => {
      const li = document.createElement('li');
      li.textContent = `${item.subject} - ${item.desc} (${item.date})`;

      const votes = document.createElement('div');
      votes.className = 'votes';

      const like = document.createElement('div');
      like.className = 'vote-btn like';
      like.innerHTML = '游녨';
      like.onclick = () => vote(item.id, table, 'up', li);

      const dislike = document.createElement('div');
      dislike.className = 'vote-btn dislike';
      dislike.innerHTML = '游녩';
      dislike.onclick = () => vote(item.id, table, 'down', li);

      votes.appendChild(like);
      votes.appendChild(dislike);
      li.appendChild(votes);

      ul.appendChild(li);
    });
  }

  async function vote(id, table, type, li) {
    const userIp = await ip();

    const { data: existingVote } = await supabase
      .from(`${table}_votes`)
      .select('*')
      .eq('item_id', id)
      .eq('ip', userIp)
      .limit(1);

    if (existingVote.length > 0) {
      alert('Ji jste hlasovali!');
      return;
    }

    await supabase.from(`${table}_votes`).insert([{ item_id: id, ip: userIp, type }]);

    // Aktualizace po캜tu hlas콢 v hlavn칤 tabulce
    const { data: item } = await supabase.from(table).select('*').eq('id', id).single();
    const column = type === 'up' ? 'up' : 'down';
    const newValue = (item[column] || 0) + 1;

    await supabase.from(table).update({ [column]: newValue }).eq('id', id);

    // P콏esunut칤 do hlavn칤 tabulky, pokud >=2 hlasy proti
    if (item.up + (type === 'up'?1:0) >= 2) {
      const targetTable = table.includes('tasks') ? 'task' : 'tests';
      await supabase.from(targetTable).insert([{ subject: item.subject, desc: item.desc, date: item.date }]);
      await supabase.from(table).delete().eq('id', id);
    }

    loadData();
  }

  // P콏id치n칤 n치vrhu
  async function addPendingTask() {
    const subject = document.getElementById('task-subject').value;
    const desc = document.getElementById('task-desc').value;
    const date = document.getElementById('task-date').value;
    if (!subject || !desc || !date) return alert('Vypl켿te v코echna pole');
    await supabase.from('tasks_pending').insert([{ subject, desc, date, up: 0, down: 0 }]);
    loadData();
  }

  async function addPendingTest() {
    const subject = document.getElementById('test-subject').value;
    const desc = document.getElementById('test-desc').value;
    const date = document.getElementById('test-date').value;
    if (!subject || !desc || !date) return alert('Vypl켿te v코echna pole');
    await supabase.from('tests_pending').insert([{ subject, desc, date, up: 0, down: 0 }]);
    loadData();
  }

  loadData();
</script>

</body>
</html>
