<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8">
<title>√ökoly & Testy</title>
<style>
body {
    margin: 0;
    background: #121212;
    color: white;
    font-family: Arial, sans-serif;
    display: flex;
    justify-content: space-between;
    padding: 20px;
}
.column {
    width: 48%;
    background: #1e1e1e;
    padding: 20px;
    border-radius: 15px;
    box-shadow: 0 0 10px #0008;
}
h2 { margin-top:0; border-bottom:2px solid #333; padding-bottom:10px; }
input, textarea, select {
    width: 100%;
    padding: 10px;
    margin: 8px 0;
    border-radius: 10px;
    background: #2c2c2c;
    color: white;
    border: none;
}
button {
    width: 100%;
    padding: 12px;
    border: none;
    background: #00aaff;
    color: white;
    border-radius: 20px;
    font-size: 16px;
    cursor: pointer;
}
button:hover { background: #0095dd; }
.item {
    background: #252525;
    padding: 12px;
    border-radius: 12px;
    margin: 10px 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.vote-box { display:flex; gap:10px; }
.vote-btn {
    width:32px; height:32px; border-radius:50%;
    cursor:pointer; opacity:0.6;
    display:flex; justify-content:center; align-items:center;
    font-size:18px; user-select:none;
}
.vote-btn.like { background:#00ff0030; }
.vote-btn.dislike { background:#ff000030; }
.vote-btn:hover { opacity:1; }
</style>
</head>
<body>

<div class="column">
    <h2>Dom√°c√≠ √∫koly</h2>
    <div id="tasks"></div>

    <h3>P≈ôidat √∫kol</h3>
    <input id="taskSubject" placeholder="P≈ôedmƒõt (1‚Äì2 p√≠smena)">
    <input id="taskDesc" placeholder="Popis √∫kolu">
    <input id="taskDate" type="date">
    <button id="btnTask">Odeslat</button>

    <h3>Nepotvrzen√© n√°vrhy</h3>
    <div id="tasksPending"></div>
</div>

<div class="column">
    <h2>Testy</h2>
    <div id="tests"></div>

    <h3>P≈ôidat test</h3>
    <input id="testSubject" placeholder="P≈ôedmƒõt (1‚Äì2 p√≠smena)">
    <input id="testDesc" placeholder="Popis testu">
    <input id="testDate" type="date">
    <button id="btnTest">Odeslat</button>

    <h3>Nepotvrzen√© n√°vrhy</h3>
    <div id="testsPending"></div>
</div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/supabase.min.js";

const supabaseUrl = "https://ihzhwcuxheclfomcwclr.supabase.co";
const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imloemh3Y3V4aGVjbGZvbWN3Y2xyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ0NDg0MTQsImV4cCI6MjA4MDAyNDQxNH0.zTTtyAc3-R3um8ytT5RyJh9kOTy_d7hzL93xIxu71KM";
const supabase = createClient(supabaseUrl, supabaseKey);

let pendingData = { task: [], test: [] };

// Funkce p≈ôid√°n√≠ √∫kolu/testu
async function addItem(type){
    const prefix = type==='task'?'task':'test';
    const subject = document.getElementById(prefix+'Subject').value.trim();
    const desc = document.getElementById(prefix+'Desc').value.trim();
    const date = document.getElementById(prefix+'Date').value;
    if(!subject||!desc||!date){ alert("Vypl≈à v≈°echna pole!"); return; }

    const { data, error } = await supabase.from(type+"_pending")
        .insert([{subject, desc, date, up:0, down:0}]);

    if(error){ console.error(error); alert("Chyba p≈ôi p≈ôid√°v√°n√≠, zkontroluj konzoli."); return; }

    document.getElementById(prefix+'Subject').value='';
    document.getElementById(prefix+'Desc').value='';
    document.getElementById(prefix+'Date').value='';

    fetchData();
}

// Funkce hlasov√°n√≠
async function vote(type, id, isUp){
    const voteKey = type+"_"+id;
    if(localStorage.getItem(voteKey)){ alert("U≈æ jsi hlasoval."); return; }

    const item = pendingData[type].find(x=>x.id===id);
    if(!item) return;

    const { error } = await supabase.from(type+"_pending")
        .update({ up: item.up + (isUp?1:0), down: item.down + (!isUp?1:0) })
        .eq('id', id);

    if(error){ console.error(error); return; }

    localStorage.setItem(voteKey,'1');

    // p≈ôesunout pokud down >=2
    const newUp = item.up + (isUp?1:0);
    const newDown = item.down + (!isUp?1:0);
    if(newDown>=2){
        const { data, error } = await supabase.from(type+"s").insert([{subject:item.subject,desc:item.desc,date:item.date}]);
        if(error) console.error(error);
        await supabase.from(type+"_pending").delete().eq('id',id);
    }

    fetchData();
}

// vykreslen√≠ seznam≈Ø
function renderItems(type, items, targetId){
    const list = document.getElementById(targetId);
    list.innerHTML="";
    items.sort((a,b)=>a.date.localeCompare(b.date));
    items.forEach(item=>{
        const div = document.createElement('div');
        div.className='item';
        div.innerHTML=`<div><b>${item.subject}</b> ‚Äì ${item.desc}<br><small>${item.date}</small></div>`;
        list.appendChild(div);
    });
}

function renderPending(type, items, targetId){
    const list = document.getElementById(targetId);
    list.innerHTML="";
    pendingData[type]=items;
    items.forEach(item=>{
        const div = document.createElement('div');
        div.className='item';
        div.innerHTML=`
            <div><b>${item.subject}</b> ‚Äì ${item.desc}<br><small>${item.date}</small></div>
            <div class="vote-box">
                <div class="vote-btn like" onclick="vote('${type}','${item.id}',true)">üëç</div>
                <div class="vote-btn dislike" onclick="vote('${type}','${item.id}',false)">üëé</div>
            </div>
        `;
        list.appendChild(div);
    });
}

// naƒçten√≠ dat z Supabase
async function fetchData(){
    let { data: tasks, error } = await supabase.from('tasks').select('*');
    if(error) console.error(error);
    renderItems('task',tasks||[],'tasks');

    let { data: tasksPending, error: e2 } = await supabase.from('tasks_pending').select('*');
    if(e2) console.error(e2);
    renderPending('task',tasksPending||[],'tasksPending');

    let { data: tests, error: e3 } = await supabase.from('tests').select('*');
    if(e3) console.error(e3);
    renderItems('test',tests||[],'tests');

    let { data: testsPending, error: e4 } = await supabase.from('tests_pending').select('*');
    if(e4) console.error(e4);
    renderPending('test',testsPending||[],'testsPending');
}

// p≈ôipojen√≠ tlaƒç√≠tek
document.getElementById("btnTask").addEventListener("click",()=>addItem('task'));
document.getElementById("btnTest").addEventListener("click",()=>addItem('test'));

// Realtime aktualizace
supabase.from('tasks').on('INSERT',fetchData).subscribe();
supabase.from('tasks_pending').on('INSERT',fetchData).subscribe();
supabase.from('tasks_pending').on('UPDATE',fetchData).subscribe();
supabase.from('tasks_pending').on('DELETE',fetchData).subscribe();

supabase.from('tests').on('INSERT',fetchData).subscribe();
supabase.from('tests_pending').on('INSERT',fetchData).subscribe();
supabase.from('tests_pending').on('UPDATE',fetchData).subscribe();
supabase.from('tests_pending').on('DELETE',fetchData).subscribe();

// inicialn√≠ naƒçten√≠
fetchData();

</script>
</body>
</html>
